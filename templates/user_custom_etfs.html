{% extends "base.html" %}

{% block title %}我的自定义ETF - ETF网格交易助手{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">我的自定义ETF</h1>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="{% if category == 'success' %}bg-green-100 border border-green-400 text-green-700{% else %}bg-red-100 border border-red-400 text-red-700{% endif %} px-4 py-3 rounded mb-4">
                    <p>{{ message }}</p>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="mb-10">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">添加自定义ETF</h2>
            <p class="text-sm text-gray-600 mb-4">
                您可以添加非官方ETF或LOF到您的个人列表，仅对您可见。这些ETF会出现在您的个人页面中，但不会在公共页面显示。
            </p>
            
            <form id="add-etf-form" class="space-y-4 max-w-lg">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                
                <div>
                    <label for="etf_code" class="block text-sm font-medium text-gray-700 mb-1">ETF代码</label>
                    <input type="text" id="etf_code" name="symbol" required placeholder="请输入ETF或LOF代码，如：510300"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="flex items-center">
                    <button type="submit" id="verify-add-etf-btn"
                        class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition duration-300">
                        <i class="fas fa-plus-circle mr-1"></i> 验证并添加
                    </button>
                    <span class="text-sm text-gray-500 ml-3">系统将验证该代码是否为有效的ETF或LOF</span>
                </div>
            </form>
        </div>
        
        <div>
            <h2 class="text-lg font-semibold text-gray-800 mb-4">我已添加的ETF</h2>
            
            {% if not custom_etfs %}
            <div class="bg-gray-50 rounded-lg p-8 text-center">
                <div class="text-gray-400 mb-3"><i class="fas fa-folder-open text-4xl"></i></div>
                <p class="text-gray-600">您还没有添加任何自定义ETF</p>
                <p class="text-sm text-gray-500 mt-2">使用上方的表单添加您感兴趣的ETF</p>
            </div>
            {% else %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for etf in custom_etfs %}
                <div class="bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300">
                    <div class="p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-medium text-gray-800">{{ etf.display_name or etf.name }}</h3>
                                <p class="text-sm text-gray-500">{{ etf.symbol }}</p>
                            </div>
                            <div class="dropdown relative">
                                <button class="text-gray-500 hover:text-gray-700 focus:outline-none">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div class="dropdown-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
                                    <a href="{{ url_for('user_etf_data') }}?symbol={{ etf.symbol }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <i class="fas fa-chart-line mr-2"></i> 查看数据分析
                                    </a>
                                    <button type="button" class="delete-etf-btn block w-full px-4 py-2 text-sm text-red-600 hover:bg-gray-100 text-left" data-symbol="{{ etf.symbol }}">
                                        <i class="fas fa-trash-alt mr-2"></i> 删除
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 flex justify-between items-center">
                            <span class="text-xs text-gray-500">添加于: {{ etf.added_at[:10] }}</span>
                            <a href="{{ url_for('user_etf_data') }}?symbol={{ etf.symbol }}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                查看详情 <i class="fas fa-chevron-right ml-1 text-xs"></i>
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 加载状态对话框 -->
<div id="loadingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
            <p class="text-gray-700 text-lg">正在获取ETF信息，请稍候...</p>
        </div>
    </div>
</div>

<!-- 确认对话框 -->
<div id="etf-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">确认添加ETF</h3>
            <button type="button" id="close-confirm-modal" class="text-gray-400 hover:text-gray-500">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mb-6">
            <p class="text-gray-700 mb-4">您确定要添加以下ETF吗？</p>
            <div class="bg-gray-50 p-4 rounded-lg">
                <p class="mb-2"><span class="font-semibold">代码：</span><span id="etf-code" class="ml-2"></span></p>
                <p class="mb-2"><span class="font-semibold">名称：</span><span id="etf-name" class="ml-2"></span></p>
                <p><span class="font-semibold">当前价格：</span><span id="etf-price" class="ml-2">数据获取中...</span></p>
            </div>
        </div>
        <div class="flex justify-end space-x-3">
            <button type="button" id="cancel-add-etf-btn" 
                class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200">
                取消
            </button>
            <button type="button" id="confirm-add-etf-btn"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
                确认添加
            </button>
        </div>
    </div>
</div>

<!-- 删除确认对话框 -->
<div id="delete-etf-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">确认删除ETF</h3>
            <button type="button" id="close-delete-modal" class="text-gray-400 hover:text-gray-500">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mb-6">
            <p class="text-gray-700 mb-4">您确定要删除此ETF吗？此操作将从您的自定义ETF列表中移除该ETF。</p>
            <div class="bg-gray-50 p-4 rounded-lg">
                <p class="mb-2"><span class="font-semibold">ETF代码：</span><span id="delete-etf-code" class="ml-2"></span></p>
            </div>
        </div>
        <div class="flex justify-end space-x-3">
            <button type="button" id="cancel-delete-etf-btn" 
                class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200">
                取消
            </button>
            <button type="button" id="confirm-delete-etf-btn"
                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200">
                确认删除
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadingModal = document.getElementById('loadingModal');
    const confirmModal = document.getElementById('etf-confirm-modal');
    const deleteModal = document.getElementById('delete-etf-modal');
    let currentSymbol = '';

    // 显示/隐藏模态框的函数
    const showModal = (modal) => {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    };

    const hideModal = (modal) => {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    };

    // 处理下拉菜单
    const dropdownButtons = document.querySelectorAll('.dropdown button');
    dropdownButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            event.stopPropagation();
            const menu = this.nextElementSibling;
            
            // 关闭其他所有下拉菜单
            document.querySelectorAll('.dropdown-menu').forEach(otherMenu => {
                if (otherMenu !== menu) {
                    otherMenu.classList.add('hidden');
                }
            });
            
            // 切换当前下拉菜单
            menu.classList.toggle('hidden');
        });
    });

    // 点击页面其他地方关闭所有下拉菜单
    document.addEventListener('click', function() {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.classList.add('hidden');
        });
    });

    // 阻止下拉菜单内部点击事件冒泡
    document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.addEventListener('click', function(event) {
            event.stopPropagation();
        });
    });

    // 处理添加ETF表单提交
    document.getElementById('add-etf-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const symbol = document.getElementById('etf_code').value.trim();
        if (!symbol) {
            alert('请输入ETF代码');
            return;
        }

        currentSymbol = symbol;
        
        try {
            // 显示加载状态
            showModal(loadingModal);
            
            // 获取ETF名称
            const nameResponse = await fetch(`/api/etf_name/${symbol}`);
            const nameData = await nameResponse.json();
            
            if (nameData.success) {
                // 获取ETF价格信息
                const priceResponse = await fetch(`/api/etf_info/${symbol}`);
                const priceData = await priceResponse.json();
                
                // 隐藏加载状态
                hideModal(loadingModal);
                
                // 更新确认对话框内容
                document.getElementById('etf-name').textContent = nameData.name || symbol;
                document.getElementById('etf-code').textContent = symbol;
                document.getElementById('etf-price').textContent = priceData.price ? 
                    `¥${priceData.price.toFixed(3)}` : 
                    '暂无价格数据';
                
                // 显示确认对话框
                showModal(confirmModal);
            } else {
                hideModal(loadingModal);
                alert(nameData.error || '获取ETF信息失败');
            }
        } catch (error) {
            hideModal(loadingModal);
            alert('获取ETF信息时发生错误');
            console.error('Error:', error);
        }
    });

    // 处理确认添加按钮点击
    document.getElementById('confirm-add-etf-btn').addEventListener('click', function() {
        // 隐藏确认对话框
        hideModal(confirmModal);
        
        // 创建一个隐藏的表单来提交数据
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/add_custom_etf';
        
        // 添加CSRF令牌 - 从原始表单中获取
        const originalForm = document.getElementById('add-etf-form');
        const csrfToken = originalForm.querySelector('input[name="csrf_token"]').value;
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        // 添加symbol字段
        const symbolInput = document.createElement('input');
        symbolInput.type = 'hidden';
        symbolInput.name = 'symbol';
        symbolInput.value = currentSymbol;
        form.appendChild(symbolInput);
        
        // 添加表单到文档并提交
        document.body.appendChild(form);
        
        // 调试信息
        console.log('提交表单:', {
            action: form.action,
            csrf_token: csrfToken,
            symbol: currentSymbol
        });
        
        form.submit();
    });

    // 处理取消和关闭按钮点击
    document.getElementById('cancel-add-etf-btn').addEventListener('click', () => hideModal(confirmModal));
    document.getElementById('close-confirm-modal').addEventListener('click', () => hideModal(confirmModal));
    
    // 点击模态框背景关闭模态框
    confirmModal.addEventListener('click', function(e) {
        if (e.target === confirmModal) {
            hideModal(confirmModal);
        }
    });

    // 处理删除ETF按钮
    const deleteButtons = document.querySelectorAll('.delete-etf-btn');
    deleteButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            const symbol = this.getAttribute('data-symbol');
            document.getElementById('delete-etf-code').textContent = symbol;
            currentSymbol = symbol;
            
            // 显示删除确认对话框
            showModal(deleteModal);
        });
    });
    
    // 取消删除
    document.getElementById('cancel-delete-etf-btn').addEventListener('click', function() {
        hideModal(deleteModal);
    });
    
    // 关闭删除对话框
    document.getElementById('close-delete-modal').addEventListener('click', function() {
        hideModal(deleteModal);
    });
    
    // 确认删除
    document.getElementById('confirm-delete-etf-btn').addEventListener('click', function() {
        // 创建一个隐藏的表单来提交数据
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/remove_custom_etf';
        
        // 添加CSRF令牌
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = '{{ csrf_token }}';
        form.appendChild(csrfInput);
        
        // 添加symbol字段
        const symbolInput = document.createElement('input');
        symbolInput.type = 'hidden';
        symbolInput.name = 'symbol';
        symbolInput.value = currentSymbol;
        form.appendChild(symbolInput);
        
        // 添加表单到文档并提交
        document.body.appendChild(form);
        console.log('提交删除ETF表单:', {
            action: form.action,
            csrf_token: csrfInput.value,
            symbol: symbolInput.value
        });
        form.submit();
    });
});
</script>
{% endblock %} 