{% extends "base.html" %}

{% block title %}管理员控制台 - ETF网格交易助手{% endblock %}

{% block content %}
<!-- 标题 -->
<div class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold text-gray-800">管理员控制台</h1>
        <div class="flex space-x-2">
            <a href="/admin/etfs" class="bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-2 rounded-lg transition duration-300 flex items-center">
                <i class="fas fa-chart-line mr-1"></i> ETF管理
            </a>
            <a href="/dashboard" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-2 rounded-lg transition duration-300 flex items-center">
                <i class="fas fa-chart-bar mr-1"></i> 返回仪表盘
            </a>
        </div>
    </div>
    
    <div class="bg-blue-50 rounded p-4 mb-4 border border-blue-100">
        <p class="text-gray-700"><i class="fas fa-info-circle text-blue-500 mr-2"></i> 欢迎使用管理员控制台。您可以在这里管理系统用户。</p>
    </div>
</div>

<!-- 用户管理区 -->
<div class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4 md:mb-0">用户管理</h2>
        <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3 w-full md:w-auto">
            <div class="relative flex-grow md:max-w-xs">
                <input type="text" id="user-search" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="搜索用户...">
                <button id="search-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-blue-500">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <button id="add-user-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-300 flex items-center justify-center">
                <i class="fas fa-user-plus mr-2"></i> 添加用户
            </button>
        </div>
    </div>
    
    <!-- 用户列表 -->
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white">
            <thead class="bg-gray-100">
                <tr>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">用户ID</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">用户名</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">邮箱</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">注册时间</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">角色</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">投资组合数</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200" id="user-table-body">
                {% for user in users %}
                <tr>
                    <td class="py-4 px-4 text-sm text-gray-500">{{ user.id }}</td>
                    <td class="py-4 px-4 text-sm font-medium text-gray-900">{{ user.username }}</td>
                    <td class="py-4 px-4 text-sm text-gray-500">{{ user.email }}</td>
                    <td class="py-4 px-4 text-sm text-gray-500">{{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td class="py-4 px-4 text-sm text-gray-500">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {% if user.is_admin %}bg-purple-100 text-purple-800{% else %}bg-green-100 text-green-800{% endif %}">
                            {{ "管理员" if user.is_admin else "普通用户" }}
                        </span>
                    </td>
                    <td class="py-4 px-4 text-sm text-gray-500">{{ user.portfolio_count }}</td>
                    <td class="py-4 px-4 text-sm font-medium">
                        <div class="flex space-x-2">
                            <button class="edit-user-btn text-blue-600 hover:text-blue-900" data-id="{{ user.id }}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="view-portfolios-btn text-green-600 hover:text-green-900" data-id="{{ user.id }}">
                                <i class="fas fa-folder-open"></i>
                            </button>
                            <button class="delete-user-btn text-red-600 hover:text-red-900" data-id="{{ user.id }}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- 分页 -->
    <div class="mt-4 flex items-center justify-between">
        <div class="text-sm text-gray-500">
            显示 <span id="page-start">1</span> 到 <span id="page-end">{{ users|length }}</span> 条，共 <span id="total-records">{{ total_users }}</span> 条记录
        </div>
        <div class="flex space-x-2">
            <button id="prev-page" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50" {% if page == 1 %}disabled{% endif %}>
                <i class="fas fa-chevron-left"></i>
            </button>
            <span class="px-3 py-1 bg-gray-100 rounded-lg text-gray-700">第 <span id="current-page">{{ page }}</span> 页</span>
            <button id="next-page" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50" {% if page == total_pages %}disabled{% endif %}>
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- 新增/编辑用户模态框 -->
<div id="user-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800" id="modal-title">添加用户</h3>
            <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="user-form" class="space-y-4">
            <input type="hidden" id="user-id" value="">
            <div>
                <label for="username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                <input type="text" id="username" name="username" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">邮箱</label>
                <input type="email" id="email" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                <input type="password" id="password" name="password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <p class="text-xs text-gray-500 mt-1">编辑用户时如不修改密码请留空</p>
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="is-admin" name="is_admin" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label for="is-admin" class="ml-2 block text-sm text-gray-700">设为管理员</label>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" id="cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition duration-300">
                    取消
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300">
                    确认
                </button>
            </div>
        </form>
    </div>
</div>

<!-- 删除确认模态框 -->
<div id="delete-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">确认删除</h3>
            <button id="close-delete-modal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <p class="text-gray-600 mb-6">您确定要删除此用户吗？此操作将同时删除该用户的所有投资组合和数据，且不可撤销。</p>
        
        <div class="flex justify-end space-x-3">
            <button id="cancel-delete" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition duration-300">
                取消
            </button>
            <button id="confirm-delete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-300">
                删除
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 变量定义
        const addUserBtn = document.getElementById('add-user-btn');
        const userModal = document.getElementById('user-modal');
        const closeModal = document.getElementById('close-modal');
        const cancelBtn = document.getElementById('cancel-btn');
        const userForm = document.getElementById('user-form');
        const modalTitle = document.getElementById('modal-title');
        const userId = document.getElementById('user-id');
        const username = document.getElementById('username');
        const email = document.getElementById('email');
        const password = document.getElementById('password');
        const isAdmin = document.getElementById('is-admin');
        const deleteModal = document.getElementById('delete-modal');
        const closeDeleteModalBtn = document.getElementById('close-delete-modal');
        const cancelDelete = document.getElementById('cancel-delete');
        const confirmDelete = document.getElementById('confirm-delete');
        const searchBtn = document.getElementById('search-btn');
        const userSearch = document.getElementById('user-search');
        const prevPage = document.getElementById('prev-page');
        const nextPage = document.getElementById('next-page');
        const currentPage = document.getElementById('current-page');
        
        let deleteUserId = null;
        
        // 各种函数定义
        function closeUserModal() {
            userModal.classList.add('hidden');
        }
        
        function closeDeleteModal() {
            deleteModal.classList.add('hidden');
            deleteUserId = null;
        }
        
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = type === 'success' 
                ? 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50'
                : 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // 事件监听器绑定
        addUserBtn.addEventListener('click', function() {
            modalTitle.textContent = '添加用户';
            userId.value = '';
            userForm.reset();
            userModal.classList.remove('hidden');
        });
        
        closeModal.addEventListener('click', closeUserModal);
        cancelBtn.addEventListener('click', closeUserModal);
        closeDeleteModalBtn.addEventListener('click', closeDeleteModal);
        cancelDelete.addEventListener('click', closeDeleteModal);
        
        // 表单提交处理
        userForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const isEdit = userId.value !== '';
            const apiUrl = isEdit ? `/api/admin/users/${userId.value}` : '/api/admin/users';
            const method = isEdit ? 'PUT' : 'POST';
            
            const userData = {
                username: username.value,
                email: email.value,
                is_admin: isAdmin.checked
            };
            
            if (password.value) {
                userData.password = password.value;
            }
            
            fetch(apiUrl, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': '{{ csrf_token }}'
                },
                body: JSON.stringify(userData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('操作失败');
                }
                return response.json();
            })
            .then(data => {
                closeUserModal();
                showNotification(data.message, 'success');
                
                // 刷新用户列表
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            })
            .catch(error => {
                showNotification('操作失败: ' + error.message, 'error');
            });
        });
        
        // 使用事件委托处理按钮点击
        document.addEventListener('click', function(event) {
            // 编辑用户按钮
            if (event.target.closest('.edit-user-btn')) {
                const button = event.target.closest('.edit-user-btn');
                const id = button.getAttribute('data-id');
                console.log('点击编辑用户按钮', id);
                
                fetch(`/api/admin/users/${id}`)
                .then(response => response.json())
                .then(data => {
                    modalTitle.textContent = '编辑用户';
                    userId.value = data.id;
                    username.value = data.username;
                    email.value = data.email;
                    password.value = '';
                    isAdmin.checked = data.is_admin;
                    
                    userModal.classList.remove('hidden');
                })
                .catch(error => {
                    console.error('获取用户信息失败', error);
                    showNotification('获取用户信息失败', 'error');
                });
            }
            
            // 删除用户按钮
            if (event.target.closest('.delete-user-btn')) {
                const button = event.target.closest('.delete-user-btn');
                deleteUserId = button.getAttribute('data-id');
                console.log('点击删除用户按钮', deleteUserId);
                deleteModal.classList.remove('hidden');
            }
            
            // 查看用户投资组合按钮
            if (event.target.closest('.view-portfolios-btn')) {
                const button = event.target.closest('.view-portfolios-btn');
                const id = button.getAttribute('data-id');
                console.log('点击查看用户投资组合按钮', id);
                window.location.href = `/admin/users/${id}/portfolios`;
            }
        });
        
        // 确认删除
        confirmDelete.addEventListener('click', function() {
            if (!deleteUserId) return;
            
            fetch(`/api/admin/users/${deleteUserId}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-Token': '{{ csrf_token }}'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('删除失败');
                }
                return response.json();
            })
            .then(data => {
                closeDeleteModal();
                showNotification(data.message, 'success');
                
                // 刷新用户列表
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            })
            .catch(error => {
                showNotification('删除失败: ' + error.message, 'error');
            });
        });
        
        // 搜索用户
        searchBtn.addEventListener('click', function() {
            const searchTerm = userSearch.value.trim();
            if (searchTerm) {
                window.location.href = `/admin?search=${encodeURIComponent(searchTerm)}`;
            }
        });
        
        userSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBtn.click();
            }
        });
        
        // 分页处理
        prevPage.addEventListener('click', function() {
            if (!this.disabled) {
                const currentPageNum = parseInt(currentPage.textContent);
                const searchParams = new URLSearchParams(window.location.search);
                searchParams.set('page', currentPageNum - 1);
                window.location.href = `/admin?${searchParams.toString()}`;
            }
        });
        
        nextPage.addEventListener('click', function() {
            if (!this.disabled) {
                const currentPageNum = parseInt(currentPage.textContent);
                const searchParams = new URLSearchParams(window.location.search);
                searchParams.set('page', currentPageNum + 1);
                window.location.href = `/admin?${searchParams.toString()}`;
            }
        });
    });
</script>
{% endblock %} 